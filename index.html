<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K·∫øt N·ªëi Trust Wallet & Airdrop ƒêi·ªÉm</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 10px; background: #222; color: white; margin: 0; }
        h1 { color: #ff9800; font-size: 24px; margin: 10px 0; }
        button { background: #ff9800; color: white; border: none; padding: 8px 16px; cursor: pointer; margin: 5px; border-radius: 4px; font-size: 14px; }
        button:hover { background: #e68a00; }
        button:disabled { background: #555; cursor: not-allowed; }
        #wallet-address, #points, #message, #debug { margin: 10px 0; font-size: 14px; color: #00ff00; word-break: break-all; padding: 0 10px; }
        .token { margin: 8px 0; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 8px; }
        .token img { width: 24px; height: 24px; vertical-align: middle; margin-right: 5px; }
        .token a { color: #00ff00; text-decoration: none; font-size: 12px; }
        .token a:hover { text-decoration: underline; }
        .copy-btn { background: #555; font-size: 12px; padding: 4px 8px; }
        .copy-btn:hover { background: #777; }
    </style>
</head>
<body>
    <h1>K·∫øt N·ªëi Trust Wallet & Airdrop ƒêi·ªÉm</h1>
    <button onclick="connectWallet()">üîó K·∫øt N·ªëi Trust Wallet/MetaMask</button>
    <div id="wallet-address">Ch∆∞a k·∫øt n·ªëi v√≠...</div>
    <div id="points">ƒêi·ªÉm c·ªßa b·∫°n: <span id="pointCount">0</span></div>
    <button id="claimBtn" onclick="claimPoints()">Nh·∫≠n 10 ƒëi·ªÉm</button>
    <div id="message"></div>
    <div id="debug"></div> <!-- Th√™m khu v·ª±c debug -->

    <div class="token">
        <button onclick="addCotienToken()"><img src="https://raw.githubusercontent.com/tinizone/Logo/refs/heads/main/Cotien256.png" alt="COT"> Th√™m Cotien (COT)</button>
        <a href="https://polygonscan.com/token/0x0d4013b4e2e2f89171bbe956da995757fb5a6678" target="_blank">Polygonscan</a>
        <button class="copy-btn" onclick="copyAddress('0x0d4013b4e2e2f89171bbe956da995757fb5a6678')">Copy</button>
    </div>
    <div class="token">
        <button onclick="addPixalalaToken()"><img src="https://raw.githubusercontent.com/tinizone/Logo/refs/heads/main/Pi256.png" alt="PIX"> Th√™m Pixalala (PIX)</button>
        <a href="https://polygonscan.com/token/0x1d7e521627cc4955ac8df6fe2fcb45891d0f30b7" target="_blank">Polygonscan</a>
        <button class="copy-btn" onclick="copyAddress('0x1d7e521627cc4955ac8df6fe2fcb45891d0f30b7')">Copy</button>
    </div>
    <div class="token">
        <button onclick="addTinizoneToken()"><img src="https://raw.githubusercontent.com/tinizone/Logo/refs/heads/main/Tin256.png" alt="TIN"> Th√™m Tinizone (TIN)</button>
        <a href="https://polygonscan.com/token/0xe7d8c8818106a565980315675d7adcb1d8ab1318" target="_blank">Polygonscan</a>
        <button class="copy-btn" onclick="copyAddress('0xe7d8c8818106a565980315675d7adcb1d8ab1318')">Copy</button>
    </div>

    <!-- Th∆∞ vi·ªán ethers.js v√† WalletConnect -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.0/dist/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

    <script>
        let provider, web3Provider, signer, account;
        const INFURA_URL = "https://polygon-mainnet.infura.io/v3/4372d2aef3d14c4ca2791c7b0a408832"; // S·ª≠ d·ª•ng Infura ID b·∫°n cung c·∫•p
        const debugElement = document.getElementById('debug');
        const claimBtn = document.getElementById('claimBtn');
        const pointCount = document.getElementById('pointCount');
        const message = document.getElementById('message');

        // H√†m debug
        function logDebug(message) {
            debugElement.innerText += `${new Date().toLocaleTimeString()} - ${message}\n`;
            console.log(message);
        }

        // L·∫•y ho·∫∑c kh·ªüi t·∫°o ƒëi·ªÉm d·ª±a tr√™n ƒë·ªãa ch·ªâ v√≠
        function getPoints() {
            if (!account) return 0;
            const storedData = localStorage.getItem(`points_${account}`);
            return storedData ? parseInt(storedData) : 0;
        }

        function getLastClaim() {
            if (!account) return null;
            const storedData = localStorage.getItem(`lastClaim_${account}`);
            return storedData ? new Date(storedData) : null;
        }

        function savePoints(points) {
            if (account) localStorage.setItem(`points_${account}`, points);
        }

        function saveLastClaim() {
            if (account) localStorage.setItem(`lastClaim_${account}`, new Date());
        }

        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ƒëi·ªÉm
        function updatePointsDisplay() {
            pointCount.textContent = getPoints();
        }

        // Ki·ªÉm tra tr·∫°ng th√°i claim
        function checkClaimAvailability() {
            const now = new Date();
            const lastClaim = getLastClaim();
            if (lastClaim) {
                const timeDiff = now - lastClaim;
                const hoursDiff = timeDiff / (1000 * 60 * 60);
                if (hoursDiff < 24) {
                    claimBtn.disabled = true;
                    message.textContent = 'B·∫°n ƒë√£ nh·∫≠n ƒëi·ªÉm h√¥m nay. Quay l·∫°i sau 24 gi·ªù!';
                    return false;
                }
            }
            claimBtn.disabled = false;
            message.textContent = '';
            return true;
        }

        // K·∫øt n·ªëi v√≠
        async function connectWallet() {
            logDebug("B·∫Øt ƒë·∫ßu k·∫øt n·ªëi v√≠...");
            try {
                // Ki·ªÉm tra thi·∫øt b·ªã mobile
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                logDebug(`Thi·∫øt b·ªã: ${isMobile ? 'Mobile' : 'Desktop'}`);

                // Th·ª≠ k·∫øt n·ªëi qua MetaMask/Trust Wallet
                if (window.ethereum && !isMobile) {
                    logDebug("Ph√°t hi·ªán window.ethereum, th·ª≠ k·∫øt n·ªëi...");
                    provider = new ethers.BrowserProvider(window.ethereum);
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    logDebug(`ƒê√£ nh·∫≠n accounts: ${accounts}`);
                    signer = await provider.getSigner();
                    account = await signer.getAddress();
                    logDebug(`ƒê·ªãa ch·ªâ v√≠: ${account}`);
                    document.getElementById("wallet-address").innerText = `‚úÖ ƒê√£ k·∫øt n·ªëi: ${account.substring(0, 6)}...${account.substring(account.length - 4)}`;
                    updatePointsDisplay();
                    checkClaimAvailability();
                    await switchToPolygon();
                    return;
                }

                // K·∫øt n·ªëi qua WalletConnect (∆∞u ti√™n tr√™n mobile)
                logDebug("Kh√¥ng t√¨m th·∫•y window.ethereum, th·ª≠ WalletConnect...");
                const WalletConnectProvider = window.WalletConnectProvider.default;
                web3Provider = new WalletConnectProvider({
                    rpc: {
                        137: INFURA_URL // S·ª≠ d·ª•ng Infura RPC
                    },
                    chainId: 137 // Polygon Mainnet
                });
                logDebug("WalletConnect provider ƒë∆∞·ª£c t·∫°o, k√≠ch ho·∫°t...");
                await web3Provider.enable();
                logDebug("WalletConnect ƒë√£ k√≠ch ho·∫°t, t·∫°o provider ethers...");
                provider = new ethers.BrowserProvider(web3Provider);
                signer = await provider.getSigner();
                account = await signer.getAddress();
                logDebug(`ƒê√£ k·∫øt n·ªëi qua WalletConnect, ƒë·ªãa ch·ªâ: ${account}`);
                document.getElementById("wallet-address").innerText = `‚úÖ ƒê√£ k·∫øt n·ªëi qua WalletConnect: ${account.substring(0, 6)}...${account.substring(account.length - 4)}`;
                updatePointsDisplay();
                checkClaimAvailability();
                document.getElementById("wallet-address").innerText += " | Vui l√≤ng chuy·ªÉn sang Polygon Mainnet th·ªß c√¥ng!";
            } catch (error) {
                logDebug(`L·ªói k·∫øt n·ªëi: ${error.message || 'Kh√¥ng r√µ nguy√™n nh√¢n'}`);
                document.getElementById("wallet-address").innerText = `‚ùå L·ªói: ${error.message || 'Vui l√≤ng c√†i MetaMask/Trust Wallet ho·∫∑c qu√©t QR ƒë·ªÉ k·∫øt n·ªëi!'}`;
                if (!window.ethereum) {
                    document.getElementById("wallet-address").innerText += " | Tr√™n mobile, h√£y qu√©t QR b·∫±ng MetaMask/Trust Wallet app.";
                }
            }
        }

        // Chuy·ªÉn sang m·∫°ng Polygon
        async function switchToPolygon() {
            logDebug("Th·ª≠ chuy·ªÉn sang m·∫°ng Polygon...");
            try {
                if (window.ethereum) {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x89' }]
                    });
                    logDebug("Chuy·ªÉn m·∫°ng th√†nh c√¥ng.");
                }
            } catch (switchError) {
                logDebug(`L·ªói chuy·ªÉn m·∫°ng: ${switchError.message}`);
                if (switchError.code === 4902 && window.ethereum) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x89',
                            chainName: 'Polygon Mainnet',
                            rpcUrls: [INFURA_URL],
                            nativeCurrency: { name: 'POL', symbol: 'POL', decimals: 18 },
                            blockExplorerUrls: ['https://polygonscan.com']
                        }]
                    });
                    logDebug("ƒê√£ th√™m m·∫°ng Polygon.");
                } else {
                    document.getElementById("wallet-address").innerText += ` | L·ªói m·∫°ng: ${switchError.message}. Vui l√≤ng chuy·ªÉn th·ªß c√¥ng!`;
                }
            }
        }

        // Th√™m token
        async function addToken(tokenAddress, tokenSymbol, tokenDecimals, tokenImage) {
            if (!account) {
                document.getElementById("wallet-address").innerText = "‚ùå H√£y k·∫øt n·ªëi v√≠ tr∆∞·ªõc!";
                return;
            }
            try {
                let wasAdded;
                if (window.ethereum) {
                    wasAdded = await window.ethereum.request({
                        method: 'wallet_watchAsset',
                        params: {
                            type: 'ERC20',
                            options: {
                                address: tokenAddress,
                                symbol: tokenSymbol,
                                decimals: tokenDecimals,
                                image: tokenImage
                            }
                        }
                    });
                } else if (web3Provider) {
                    document.getElementById("wallet-address").innerText += ` | Th√™m ${tokenSymbol} th·ªß c√¥ng trong v√≠ qua WalletConnect!`;
                    return;
                }
                if (wasAdded) {
                    document.getElementById("wallet-address").innerText += ` | ƒê√£ th√™m ${tokenSymbol} th√†nh c√¥ng!`;
                } else {
                    document.getElementById("wallet-address").innerText += ` | B·∫°n ƒë√£ h·ªßy th√™m ${tokenSymbol}.`;
                }
            } catch (error) {
                document.getElementById("wallet-address").innerText += ` | L·ªói: ${error.message || 'Th√™m th·ªß c√¥ng trong v√≠'}.`;
            }
        }

        function addCotienToken() { addToken("0x0d4013b4e2e2f89171bbe956da995757fb5a6678", "COT", 18, "https://raw.githubusercontent.com/tinizone/Logo/refs/heads/main/Cotien256.png"); }
        function addPixalalaToken() { addToken("0x1d7e521627cc4955ac8df6fe2fcb45891d0f30b7", "PIX", 18, "https://raw.githubusercontent.com/tinizone/Logo/refs/heads/main/Pi256.png"); }
        function addTinizoneToken() { addToken("0xe7d8c8818106a565980315675d7adcb1d8ab1318", "TIN", 18, "https://raw.githubusercontent.com/tinizone/Logo/refs/heads/main/Tin256.png"); }

        // Nh·∫≠n ƒëi·ªÉm
        function claimPoints() {
            if (!account) {
                message.textContent = "‚ùå H√£y k·∫øt n·ªëi v√≠ Trust Wallet ho·∫∑c MetaMask tr∆∞·ªõc!";
                return;
            }
            if (checkClaimAvailability()) {
                const newPoints = getPoints() + 10;
                savePoints(newPoints);
                saveLastClaim();
                updatePointsDisplay();
                claimBtn.disabled = true;
                message.textContent = 'B·∫°n v·ª´a nh·∫≠n 10 ƒëi·ªÉm!';
                setTimeout(() => {
                    message.textContent = '';
                }, 3000);
            }
        }

        // Copy ƒë·ªãa ch·ªâ
        function copyAddress(address) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(address).then(() => {
                    document.getElementById("wallet-address").innerText += " | ƒê√£ sao ch√©p!";
                }).catch(() => fallbackCopy(address));
            } else {
                fallbackCopy(address);
            }
        }

        function fallbackCopy(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            document.getElementById("wallet-address").innerText += " | ƒê√£ sao ch√©p (fallback)!";
        }

        // Ki·ªÉm tra khi t·∫£i trang
        window.onload = function() {
            logDebug("Trang ƒë√£ t·∫£i, ki·ªÉm tra v√≠...");
            if (window.ethereum && window.ethereum.selectedAddress) {
                connectWallet();
            } else {
                logDebug("Kh√¥ng t√¨m th·∫•y window.ethereum.");
                document.getElementById("wallet-address").innerText = "‚ùå Vui l√≤ng c√†i MetaMask/Trust Wallet ho·∫∑c qu√©t QR ƒë·ªÉ k·∫øt n·ªëi!";
            }
            checkClaimAvailability();
        };
    </script>
</body>
</html>
